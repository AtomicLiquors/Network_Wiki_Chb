[<<메인으로](https://github.com/AtomicLiquors/Network_Wiki_Chb)

&nbsp;  
&nbsp;  
# 로드 밸런서
서버 및 장비의 트래픽 부하를 분산하기 위해 사용하는 장비.  

 
&nbsp;
 



## 왜 필요한가?  

서비스 하나는 보통 두 대 이상의 서버로 구성됩니다.
서버를 한 대만 운용하면,  
서비스 규모가 커지면 서비스를 모두 수용할 수 없게 됩니다.  
또한 서버 한 대만 장애가 발생해도 모든 서비스가 중단됩니다.  

서버를 여러 대 운용할 경우 서로 IP 주소가 다르기 때문에,  
서비스를 요청할 때 어떤 IP를 가진 서버로 요청할지 결정해야 합니다.

&nbsp;



### "L4 스위치"
- 4계층 이상에서 동작하면서 로드 밸런서 기능이 있는 스위치.  

- 또는 로드 밸런서를 그냥 'L4 스위치'라고도 한다.  

    부하분산을 위해 그룹을 만들 때는  
    IP주소(3계층)뿐 아니라 서비스 포트(4계층)까지 지정하여 만들기 때문이다.

 
&nbsp;
 

### "L7 스위치"
로드 밸런서가 7계층 정보까지 확인하는 경우 L7 스위치라고도 한다.  
(HTTP, FTP, SMTP와 같은 애플리케이션 프로토콜 정보)  
다양한 부하분산, 정보수정, 정보 필터링  


**ADC** *Application Delivery Controller*  
- 상세한 동작을 위하여 프록시로 동작한다.  
- 부하가 큰 정적 콘탠츠 캐싱 기능  



 

&nbsp;  

&nbsp;  
## **동작 방식**
- SLB *Server Load Balancing* :   
서버 부하를 분산하는 경우.

- FWLB *Firewall Load Balancing* :   
방화벽 부하를 분산하는 경우.

    패킷이 방화벽 정책에 부합하여 방화벽을 통과하면,  
    방화벽은 자신이 가진 세션 테이블에 패킷의 정보를 기록한다.  
    응답 패킷은 방화벽 정책을 확인하는 게 아니라 세션 테이블에서 패킷을 먼저 조회한다.  
    응답 패킷이 세션 테이블에 없다면, 요청한 적이 없는 패킷에 대한 응답으로 간주하고 폐기된다.

&nbsp;
- VPNLB *VPN Load Balancing*   
 
&nbsp;
 
&nbsp;  


## **관련 개념**

### **스케일 업** 
기존 시스템에 내부 컴포넌트 용량을 키우거나(CPU, 메모리, 디스크 등)  
용량이 더 큰 시스템을 새로 구매하고 서비스를 이전하는 방법
- [pros] 부품 추가만 된다면, 시스템 설계를 변경하지 않고도   
서비스 사용량을 쉽게 늘릴 수 있다.
- [cons] 부품 추가가 어렵다. 시스템이 커질수록 비용도 가파르게 늘어난다.

- 주로 기존 대형 유닉스 시스템에서 사용한다.

&nbsp;

### **스케일 아웃** 
서버 여러 대로 부하를 분산하는 방법.  
서비스 자체를 구분하거나,  
같은 서비스를 분산해 처리할 수 있다.

- [pros] 적은 비용, 결함허용*Fault Tolerance* 구현

- [cons] 아키텍처가 복잡하고 프로세스, 네트워크 장비가 추가로 필요할 수 있다.

 
&nbsp;
 



### VIP
= 또는 서비스 IP 주소라고도 한다.  

로드 밸런서가 갖는 가상 IP.  
모든 요청들을 VIP로 받아들인 다음,  
적절한 서버의 IP로 요청을 전송한다.

&nbsp;


&nbsp;   
### 리얼 IP
실제 트래픽을 받을 개별 서버의 IP.

 
&nbsp;
 
 
&nbsp;
 

 
## **부하 분산 알고리즘**
- **라운드로빈** *Round Robin*  
부하를 순차적으로 분산함.  
총 누적 세션 수는 동일하지면, 활성화된 세션 수는 달라질 수 있다.

- **최소 접속 방식** *Least Connection*  
활성화된 세션 수가 가장 적은 장비로 부하를 분산

- **가중치 기반 라운드로빈** *Weighted Round Robin*  
라운드로빈 방식 + 각 장비에 가중치
가중치가 높으면 부하를 더 많이 분산한다.  
처리 용량이 상이한 서버에 부하를 분산하기 위한 알고리즘

- **가중치 기반 최소 접속 방식** *Weighted Least Connection*  
최소 접속 방식 + 각 장비에 가중치
이하 전과 동.  

- **해시** *Hash*  
해시 알고리즘을 이용한 부하 분산.

 
&nbsp;
 
 
&nbsp;
 
## **로드 밸런서 구성 방식**
(그림 찾아서 넣어줘)
### **원암** *One-Arm*
로드 밸런서가 중간 스위치 옆에 연결되는 구성.

### **인라인** *Inline*
로드 밸런서가 서버로 가는 경로상에 연결되는 구성.

 
&nbsp;
 
 
&nbsp;
 
## **동작 모드**
### **트랜스패런트(TP) / 브릿지** 
로드밸런서가 스위치처럼 동작하는 구성.  
= VIP주소와 실제 서버가 동일한 네트워크를 사용한다.

부하 분산 서비스를 받는 트래픽만 4계층 이상의 기능을 수행한다.  
나머지는 스위칭 기능만 수행한다.

장점 : 기존 네트워크 대역을 그대로 사용한다.  
로드 밸런서 도입에 따른 IP 네트워크 재설계가 불필요하다.  
네트워크에 스위치를 추가하듯 트래픽에 영향을 끼치지 않고 구성이 가능하다.  


&nbsp;
 
### **라우티드** *Routed*
로드 밸런서가 라우터 역할을 수행하는 방식  
= 사용자 방향과 서버 방향이 서로 다른 네트워크로 분리된 구성  
(원암 구성과 인라인 구성에서 모두 구성 가능)
- 응용 - 보안 강화 목적 : 서버 쪽 네트워크를 사설로 구성해, 직접 접속을 막는다.

 
&nbsp;
 

### **DSR** *Direct Server Return*
요청만 로드 밸런서를 거치고,  
응답은 사용자에게 직접 돌아옴  

로드 밸런서 또한 사용자의 요청 패킷에 대해서만 관여한다.  
응답시 로드밸런서를 경유하지 않으므로 원암으로 구성한다.  

다른 방식과 달리 서버에서도 추가 설정이 필요하다.  
자세한 내용은 다음에 추가 바람.   

 
&nbsp;
 

## **구성 시 유의사항**
### 원암 구성의 동일 네트워크 사용 시
사용자에게 바로 응답할 경우  
요청 IP와 실제로 응답한 서버 IP 간의 괴리가 발생,  
사용자는 '요청하지 않은 IP의 응답'으로 판단해 패킷을 폐기한다.  

- 게이트웨이를 로드 밸런서로 설정하기  
- Source NAT 사용
- DSR 모드
- 동일 네트워크 내에서 VIP 호출

 
&nbsp;
 
## **HAProxy**
오픈 소스 기반의 소프트웨어 로드 밸런서  
기존 하드웨어 로드밸런서의 역할을 일반 서버에서 수행할 수 있게 해준다.