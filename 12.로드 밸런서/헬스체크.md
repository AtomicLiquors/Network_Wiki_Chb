[<<메인으로](https://github.com/AtomicLiquors/Network_Wiki_Chb)

&nbsp;  
&nbsp;  
# 헬스체크
로드밸런서와 연결된 서버에 장애가 발생한다면

로드 밸런서는 주기적으로 각 서버의 상태를 체크한다.  
상태가 정상인 서비스로만 부하를 분산하고,  
비정상적인 서버는 서비스 그룹에서 제외한다.  

그 뒤로도 계속 상태를 체크하여 정상이라면,   
다시 그룹에 포함시키고 트래픽을 유입시킨다.  

&nbsp;  
&nbsp;  
## 체크 방식
### ICMP
VIP로 연결된 ping으로 상태를 체크하는 방법.  
서버가 죽었는지 살았는지만 알 수 있다.  
잘 사용하지 않는다.  

&nbsp;  
### TCP 서비스 포트
가장 기본적인 헬스 체크 수단.  
로드 밸런서에 설정된 서버의 서비스 포트를 확인한다.   
SYN/SYN, ACK/ACK까지 정상적인 3방향 핸드셰이크를 거치게 된다. 

|  |
|--|
|로드 밸런서에서 서버의 서비스 포트 2000번을 등록했다면,  |
|로드 밸런서에서는 리얼 IP의 2000번 포트로 SYN을 보내고 |
|해당 리얼 IP를 가진 서버한테 SYN, ACK를 받으면|
|서버에 다시 ACK로 응답하고 FIN을 보낸다. |
|헬스 체크 종료.|
||

* Half Open :  
부하를 줄이거나 빨리 체크 세션을 끊고 싶을 때.  
SYN을 보내고 SYN, ACK를 받는 건 똑같지만  
그 후 ACK 대신 RST를 보내 세션을 끊는다.


&nbsp;  

### HTTP 상태 코드
서비스 포트까지는 TCP로 정상적으로 열리지만 웹 서비스에 대한 응답을 정상적으로 해주지 못하는 경우

 
&nbsp;
 
### **콘텐츠 확인(문자열 확인)**
사전에 문자열을 지정하여    
지정된 문자열이 웹페이지에 포함되었는지 체크
 
&nbsp;
 
### **헬스체크 주기와 타이머**
- **주기** *Interval*  
로드 밸런서에서 서버로 헬스체크 패킷을 보내는 주기

- **응답 시간** *Response*  
로드 밸런서에서 서버로 헬스체크 패킷을 보내고 응답을 기다리는 시간  
해당시간까지 응답이 오지 않으면 실패로 간주

- **시도 횟수** *Retries*  
헬스 체크 실패시 최대 시도 횟수  
최대 시도 횟수 이전에 성공 시 시도 횟수는 초기화된다.

- **타임아웃** *Timeout*  
헬스 체크 실패 시 최대 대기 시간
패킷을 서버로 전송한 후, 이 시간 내에 성공하지 못하면 해당 서버는 다운

- **서비스 다운 시의 주기** *Dead Interval*  
서비스의 기본적인 헬스 체크 주기가 아닌,  
서비스 다운 시의 헬스 체크 주기.  
헬스 체크 주기를 별도로 더 늘릴 때 사용

 
&nbsp;
 

 
&nbsp;


